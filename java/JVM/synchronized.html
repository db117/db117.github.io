<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>synchronized | 大兵个人主页</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <script>
            var _hmt = _hmt || [];
            (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?61e2d16dac6a568e22f28ee4974c119a";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
            })();
        </script>
    <meta name="description" content="文档">
    
    <link rel="preload" href="/assets/css/0.styles.74761522.css" as="style"><link rel="preload" href="/assets/js/app.0602046f.js" as="script"><link rel="preload" href="/assets/js/2.0d3614ae.js" as="script"><link rel="preload" href="/assets/js/26.ba3f6ee3.js" as="script"><link rel="prefetch" href="/assets/js/10.d565d491.js"><link rel="prefetch" href="/assets/js/100.12ed9cae.js"><link rel="prefetch" href="/assets/js/101.a96f6ebc.js"><link rel="prefetch" href="/assets/js/102.881c6614.js"><link rel="prefetch" href="/assets/js/103.93b2e2e5.js"><link rel="prefetch" href="/assets/js/104.3941692b.js"><link rel="prefetch" href="/assets/js/105.0ad65f0c.js"><link rel="prefetch" href="/assets/js/106.38898452.js"><link rel="prefetch" href="/assets/js/107.ad8a36ea.js"><link rel="prefetch" href="/assets/js/108.1bff9906.js"><link rel="prefetch" href="/assets/js/109.c054635c.js"><link rel="prefetch" href="/assets/js/11.40fbe5c0.js"><link rel="prefetch" href="/assets/js/110.5df2114c.js"><link rel="prefetch" href="/assets/js/111.c45c108b.js"><link rel="prefetch" href="/assets/js/112.a168dadc.js"><link rel="prefetch" href="/assets/js/113.9462b7ce.js"><link rel="prefetch" href="/assets/js/114.e9e6fb7a.js"><link rel="prefetch" href="/assets/js/115.27157b3c.js"><link rel="prefetch" href="/assets/js/116.3df1735f.js"><link rel="prefetch" href="/assets/js/117.57b9bca9.js"><link rel="prefetch" href="/assets/js/118.df117b2a.js"><link rel="prefetch" href="/assets/js/119.ea8f8240.js"><link rel="prefetch" href="/assets/js/12.d328b642.js"><link rel="prefetch" href="/assets/js/120.7c770cb4.js"><link rel="prefetch" href="/assets/js/121.976e8c5a.js"><link rel="prefetch" href="/assets/js/122.225b8938.js"><link rel="prefetch" href="/assets/js/13.dcf4152c.js"><link rel="prefetch" href="/assets/js/14.5587ba0f.js"><link rel="prefetch" href="/assets/js/15.466dfcf2.js"><link rel="prefetch" href="/assets/js/16.93957ed0.js"><link rel="prefetch" href="/assets/js/17.0a3ebf8a.js"><link rel="prefetch" href="/assets/js/18.1dd025b0.js"><link rel="prefetch" href="/assets/js/19.a44a845e.js"><link rel="prefetch" href="/assets/js/20.10a093b0.js"><link rel="prefetch" href="/assets/js/21.1c9de11d.js"><link rel="prefetch" href="/assets/js/22.a47dbc70.js"><link rel="prefetch" href="/assets/js/23.44eda973.js"><link rel="prefetch" href="/assets/js/24.cc7f8de2.js"><link rel="prefetch" href="/assets/js/25.285a0b95.js"><link rel="prefetch" href="/assets/js/27.51c5cfc6.js"><link rel="prefetch" href="/assets/js/28.bd89d9fa.js"><link rel="prefetch" href="/assets/js/29.cca115a3.js"><link rel="prefetch" href="/assets/js/3.5cc11bd4.js"><link rel="prefetch" href="/assets/js/30.0555e951.js"><link rel="prefetch" href="/assets/js/31.0afe8970.js"><link rel="prefetch" href="/assets/js/32.c84ecc5c.js"><link rel="prefetch" href="/assets/js/33.4a98cdc2.js"><link rel="prefetch" href="/assets/js/34.2647b892.js"><link rel="prefetch" href="/assets/js/35.a3b1fe80.js"><link rel="prefetch" href="/assets/js/36.110bf0af.js"><link rel="prefetch" href="/assets/js/37.e466b213.js"><link rel="prefetch" href="/assets/js/38.e461369f.js"><link rel="prefetch" href="/assets/js/39.cab8bd88.js"><link rel="prefetch" href="/assets/js/4.73f294e2.js"><link rel="prefetch" href="/assets/js/40.20543463.js"><link rel="prefetch" href="/assets/js/41.c8cf2ae4.js"><link rel="prefetch" href="/assets/js/42.c1cc50b5.js"><link rel="prefetch" href="/assets/js/43.e52e6f50.js"><link rel="prefetch" href="/assets/js/44.1439ac85.js"><link rel="prefetch" href="/assets/js/45.d448d587.js"><link rel="prefetch" href="/assets/js/46.ef45989a.js"><link rel="prefetch" href="/assets/js/47.84e33544.js"><link rel="prefetch" href="/assets/js/48.e794aa63.js"><link rel="prefetch" href="/assets/js/49.7fd56058.js"><link rel="prefetch" href="/assets/js/5.60d621ec.js"><link rel="prefetch" href="/assets/js/50.51c016a8.js"><link rel="prefetch" href="/assets/js/51.a3ee8fb0.js"><link rel="prefetch" href="/assets/js/52.2a2147fd.js"><link rel="prefetch" href="/assets/js/53.fa440d9a.js"><link rel="prefetch" href="/assets/js/54.14467470.js"><link rel="prefetch" href="/assets/js/55.5252954f.js"><link rel="prefetch" href="/assets/js/56.1f37ea76.js"><link rel="prefetch" href="/assets/js/57.ab0f0617.js"><link rel="prefetch" href="/assets/js/58.137d8641.js"><link rel="prefetch" href="/assets/js/59.aa9cca3b.js"><link rel="prefetch" href="/assets/js/6.2809b31b.js"><link rel="prefetch" href="/assets/js/60.1f0efeda.js"><link rel="prefetch" href="/assets/js/61.3d51144c.js"><link rel="prefetch" href="/assets/js/62.caaca556.js"><link rel="prefetch" href="/assets/js/63.e7cee954.js"><link rel="prefetch" href="/assets/js/64.da5b2234.js"><link rel="prefetch" href="/assets/js/65.419481b1.js"><link rel="prefetch" href="/assets/js/66.0a53481e.js"><link rel="prefetch" href="/assets/js/67.df09a236.js"><link rel="prefetch" href="/assets/js/68.ff6c5617.js"><link rel="prefetch" href="/assets/js/69.d68d69dc.js"><link rel="prefetch" href="/assets/js/7.69b086bc.js"><link rel="prefetch" href="/assets/js/70.a768b639.js"><link rel="prefetch" href="/assets/js/71.329acea8.js"><link rel="prefetch" href="/assets/js/72.414bc6e3.js"><link rel="prefetch" href="/assets/js/73.b6a66c9f.js"><link rel="prefetch" href="/assets/js/74.cc7d5f60.js"><link rel="prefetch" href="/assets/js/75.e09a4fe9.js"><link rel="prefetch" href="/assets/js/76.637852c5.js"><link rel="prefetch" href="/assets/js/77.ea60dd8c.js"><link rel="prefetch" href="/assets/js/78.b220338a.js"><link rel="prefetch" href="/assets/js/79.bb76b620.js"><link rel="prefetch" href="/assets/js/8.ce01e60e.js"><link rel="prefetch" href="/assets/js/80.e1714800.js"><link rel="prefetch" href="/assets/js/81.4751a415.js"><link rel="prefetch" href="/assets/js/82.76d4804e.js"><link rel="prefetch" href="/assets/js/83.73823f66.js"><link rel="prefetch" href="/assets/js/84.21163e24.js"><link rel="prefetch" href="/assets/js/85.c07fca8d.js"><link rel="prefetch" href="/assets/js/86.a5ae331e.js"><link rel="prefetch" href="/assets/js/87.3437f291.js"><link rel="prefetch" href="/assets/js/88.1a450f61.js"><link rel="prefetch" href="/assets/js/89.792e8cbc.js"><link rel="prefetch" href="/assets/js/9.84468b6b.js"><link rel="prefetch" href="/assets/js/90.c00bd8a4.js"><link rel="prefetch" href="/assets/js/91.93e1bb00.js"><link rel="prefetch" href="/assets/js/92.a8cf0f2f.js"><link rel="prefetch" href="/assets/js/93.13511ca6.js"><link rel="prefetch" href="/assets/js/94.2f411519.js"><link rel="prefetch" href="/assets/js/95.4a76b22a.js"><link rel="prefetch" href="/assets/js/96.6e4d5979.js"><link rel="prefetch" href="/assets/js/97.ea010663.js"><link rel="prefetch" href="/assets/js/98.18439af9.js"><link rel="prefetch" href="/assets/js/99.7e9bad52.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74761522.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">大兵个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  导航
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/java/" class="nav-link router-link-active">
  java
</a></div><div class="nav-item"><a href="/os/" class="nav-link">
  系统相关
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/运维/" class="nav-link">
  运维相关
</a></div> <a href="https://github.com/db117/doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  导航
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/database/" class="nav-link">
  数据库
</a></div><div class="nav-item"><a href="/java/" class="nav-link router-link-active">
  java
</a></div><div class="nav-item"><a href="/os/" class="nav-link">
  系统相关
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/util/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="/运维/" class="nav-link">
  运维相关
</a></div> <a href="https://github.com/db117/doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/" aria-current="page" class="sidebar-link">java</a></li><li><a href="/java/JMH基准测试.html" class="sidebar-link">JMH基准测试</a></li><li><a href="/java/jdk工具.html" class="sidebar-link">jdk工具</a></li><li><a href="/java/jdk源码编译.html" class="sidebar-link">jdk源码编译</a></li><li><a href="/java/线上问题查找.html" class="sidebar-link">线上问题分析</a></li><li><a href="/java/集合.html" class="sidebar-link">java集合</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/JVM/JVM参数.html" class="sidebar-link">JVM参数</a></li><li><a href="/java/JVM/jvm远程访问.html" class="sidebar-link">java开启远程访问</a></li><li><a href="/java/JVM/synchronized.html" aria-current="page" class="active sidebar-link">synchronized</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/java/JVM/垃圾回收.html" class="sidebar-link">垃圾回收</a></li><li><a href="/java/JVM/对象相关.html" class="sidebar-link">对象相关</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>spring相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/spring/" class="sidebar-link">spring相关</a></li><li><a href="/java/spring/Spring Bean接口.html" class="sidebar-link">spring Bean接口</a></li><li><a href="/java/spring/Spring-aop.html" class="sidebar-link">spring-aop</a></li><li><a href="/java/spring/SpringMVC中获取request.html" class="sidebar-link">SpringMVC中获取request</a></li><li><a href="/java/spring/Spring扩展接口即执行流程.html" class="sidebar-link">Spring扩展接口即执行流程</a></li><li><a href="/java/spring/actuator.html" class="sidebar-link">Spring Boot - Actuator</a></li><li><a href="/java/spring/error.html" class="sidebar-link">常见异常</a></li><li><a href="/java/spring/gateway.html" class="sidebar-link">gateway</a></li><li><a href="/java/spring/spring-boot启动流程.html" class="sidebar-link">spring-boot启动流程</a></li><li><a href="/java/spring/spring-webflux.html" class="sidebar-link">spring-webflux</a></li><li><a href="/java/spring/流程图合集.html" class="sidebar-link">流程图</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>spring-cloud</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/spring-cloud/" class="sidebar-link">spring-cloud</a></li><li><a href="/java/spring-cloud/gateway.html" class="sidebar-link">简介</a></li><li><a href="/java/spring-cloud/openfeign.html" class="sidebar-link">spring-cloud-openfeign</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>乱七八糟</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/乱七八糟/JAVA中的switch case是如何对String做支持的.html" class="sidebar-link">源码</a></li><li><a href="/java/乱七八糟/Java修饰符.html" class="sidebar-link">java的修饰符</a></li><li><a href="/java/乱七八糟/ip代理.html" class="sidebar-link">IP代理</a></li><li><a href="/java/乱七八糟/kafak.html" class="sidebar-link">kafka</a></li><li><a href="/java/乱七八糟/maven.html" class="sidebar-link">maven</a></li><li><a href="/java/乱七八糟/低内存海量Excel导入.html" class="sidebar-link">大量Excel导入</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>加锁目的：<strong>序列化访问临界资源</strong>，即同一时刻只能有一个线程访问临界资源(<strong>同步互斥访问</strong>)</p> <p><code>synchronized</code>内置锁是一种对象锁(锁的是对象而非引用)，作用粒度是对象，可以用来实现对临界资源的同步互斥访问，是可重入的。</p></blockquote> <iframe id="embed_dom" name="embed_dom" frameborder="0" src="https://www.processon.com/embed/60efe9987d9c0806dcf13836" style="display:block;width:725px;height:245px;"></iframe> <h3 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h3> <p>加锁的方式</p> <ul><li><p>同步实例方法，锁是当前实例对象</p></li> <li><p>同步类方法，锁是当前类对象</p></li> <li><p>同步代码块，锁是括号里面的对象</p></li></ul> <h3 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h3> <blockquote><p><strong>synchronized是基于JVM</strong>内置锁实现，通过内部对象<strong>Monitor</strong>(监视器锁)实现，基于进入与退出<strong>Monitor</strong>对象实现方法与代码块同步，监视器锁的实现依赖底层操作系统的<strong>Mutex lock</strong>（互斥锁）实现，它是一个重量级锁性能较低。当然，**JVM内置锁在1.5之后版本做了重大的优化，**如锁粗化（Lock Coarsening）、锁消除（Lock Elimination）、轻量级锁（Lightweight Locking）、偏向锁（Biased Locking）、适应性自旋（Adaptive Spinning）等技术来减少锁操作的开销，，内置锁的并发性能已经基本与Lock持平。</p> <p>synchronized关键字被编译成字节码后会被翻译成monitorenter 和 monitorexit 两条指令分别在同步块逻辑代码的起始位置与结束位置。</p></blockquote> <h4 id="monitor"><a href="#monitor" class="header-anchor">#</a> Monitor</h4> <blockquote><p><strong>任何一个对象都有一个Monitor与之关联，当且一个Monitor被持有后，它将处于锁定状态</strong>。Synchronized在JVM里的实现都是 <strong>基于进入和退出Monitor对象来实现方法同步和代码块同步</strong>，虽然具体实现细节不一样，但是都可以通过成对的MonitorEnter和MonitorExit指令来实现。</p></blockquote> <ul><li><p><strong>monitorenter</strong>：每个对象都是一个监视器锁（monitor）。当monitor被占用时就会处于锁定状态，线程执行monitorenter指令时尝试获取monitor的所有权，过程如下：</p></li> <li><ol><li><strong>如果monitor的进入数为0</strong>，则该线程进入monitor，然后将进入数设置为1，该线程即为monitor的所有者；</li> <li><strong>如果线程已经占有该monitor</strong>，只是重新进入，则进入monitor的进入数加1；</li> <li><strong>如果其他线程已经占用了monitor</strong>，则该线程进入阻塞状态，直到monitor的进入数为0，再重新尝试获取monitor的所有权；</li></ol></li> <li><p><strong>monitorexit</strong>：执行monitorexit的线程必须是objectref所对应的monitor的所有者。<strong>指令执行时，monitor的进入数减1，如果减1后进入数为0，那线程退出monitor，不再是这个monitor的所有者</strong>。其他被这个monitor阻塞的线程可以尝试去获取这个 monitor 的所有权。</p></li> <li><p><strong>ACC_SYNCHRONIZED</strong>：方法的同步并没有通过指令 <strong>monitorenter</strong> 和 <strong>monitorexit</strong> 来完成（理论上其实也可以通过这两条指令来实现），不过相对于普通方法，其常量池中多了 <strong>ACC_SYNCHRONIZED</strong> 标示符。<strong>JVM就是根据该标示符来实现方法的同步的</strong>：</p> <p>当方法调用时，<strong>调用指令将会检查方法的 ACC_SYNCHRONIZED 访问标志是否被设置</strong>，如果设置了，<strong>执行线程将先获取monitor</strong>，获取成功之后才能执行方法体，<strong>方法执行完后再释放monitor</strong>。在方法执行期间，其他任何线程都无法再获得同一个monitor对象。</p></li></ul> <h3 id="objectmonitor"><a href="#objectmonitor" class="header-anchor">#</a> ObjectMonitor</h3> <blockquote><p><strong>每一个Java对象自打娘胎里出来就带了一把看不见的锁，它叫做内部锁或者Monitor锁</strong>。</p> <p><a href="https://github.com/openjdk/jdk/blob/e92e2fd4e0bc805d8f7d70f632cce0282eb1809b/src/hotspot/share/runtime/objectMonitor.hpp" target="_blank" rel="noopener noreferrer">源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><code>ObjectWaiter</code>结构</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// 对所有需要进入的线程进行封装
class ObjectWaiter : public StackObj {
 public:
  enum TStates { TS_UNDEF, TS_READY, TS_RUN, TS_WAIT, TS_ENTER, TS_CXQ };// 线程状态
  ObjectWaiter* volatile _next;		// 下一个等待对象
  ObjectWaiter* volatile _prev;   // 上一个等待对象
  JavaThread*   _thread;					// 线程
  uint64_t      _notifier_tid;
  ParkEvent *   _event;
  volatile int  _notified;
  volatile TStates TState;					// 线程状态
  bool          _active;           // Contention monitoring is enabled
 public:
  ObjectWaiter(JavaThread* current);

  void wait_reenter_begin(ObjectMonitor *mon);
  void wait_reenter_end(ObjectMonitor *mon);
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>ObjectMonitor</code>主要结构</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>class ObjectMonitor : public CHeapObj&lt;mtInternal&gt; {
  friend class ObjectSynchronizer;
  friend class ObjectWaiter;
  friend class VMStructs;
  JVMCI_ONLY(friend class JVMCIVMStructs;)


  volatile markWord _header;    		// 对象头
  WeakHandle _object;               // 锁不是平白出现的，而是寄托存储于对象中。
  void* volatile _owner;            // 指向所属线程或栈锁的指针
  volatile uint64_t _previous_owner_tid;  // 上一个拥有当前锁的线程id
  ObjectMonitor* _next_om;          	// Next ObjectMonitor* linkage
  volatile intx _recursions;        	// 递归次数
  ObjectWaiter* volatile _EntryList;  // 处于等待锁block状态的线程，会被加入到entry set；

  ObjectWaiter* volatile _cxq;      // LL of recently-arrived threads blocked on entry.
  JavaThread* volatile _succ;       // Heir presumptive thread - used for futile wakeup throttling
  int _contentions;                 // 竞争数量

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="对象头"><a href="#对象头" class="header-anchor">#</a> 对象头</h3> <blockquote><p>所有对象都有的。主要包含锁状态，以及hash值，gc信息</p> <p><a href="https://github.com/openjdk/jdk/blob/e92e2fd4e0bc805d8f7d70f632cce0282eb1809b/src/hotspot/share/oops/markWord.hpp" target="_blank" rel="noopener noreferrer">源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><strong>32位</strong></p> <table><thead><tr><th></th> <th>25bit</th> <th>4bit</th> <th>1bit</th> <th>2bit</th></tr></thead> <tbody><tr><td>锁状态</td> <td></td> <td>分代年龄</td> <td>是否偏向锁（是否禁用偏向）</td> <td>锁标志位</td></tr> <tr><td>无锁态</td> <td>对象的hashCode</td> <td></td> <td>0</td> <td>01</td></tr> <tr><td>轻量级锁</td> <td>指向栈中锁记录的指针</td> <td></td> <td></td> <td>00</td></tr> <tr><td>重量级锁</td> <td>指向Monitor的指针</td> <td></td> <td></td> <td>10</td></tr> <tr><td>GC标记</td> <td>空</td> <td></td> <td></td> <td>11</td></tr> <tr><td>偏向锁</td> <td>线程ID/Epoch(2bit)</td> <td></td> <td>1</td> <td>01</td></tr></tbody></table> <div class="language- line-numbers-mode"><pre class="language-text"><code>//  jdk源码注释
//  32 bits:
//  --------
//             hash:25 ------------&gt;| age:4  unused_gap:1  lock:2 (normal object)
//
//  64 bits:
//  --------
//  unused:25 hash:31 --&gt;| unused_gap:1  age:4  unused_gap:1  lock:2 (normal object)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>对象头分析工具</strong></p> <blockquote><p>分析java对象的工具包</p> <p><a href="https://openjdk.java.net/projects/code-tools/jol/" target="_blank" rel="noopener noreferrer">OpenJDK: jol (java.net)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/openjdk/jol" target="_blank" rel="noopener noreferrer">github.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="锁升级"><a href="#锁升级" class="header-anchor">#</a> 锁升级</h3> <blockquote><p>锁的状态总共有四种，无锁状态、偏向锁、轻量级锁和重量级锁。随着锁的竞争，锁可以从偏向锁升级到轻量级锁，再升级的重量级锁，但是锁的升级是单向的，也就是说只能从低到高升级，不会出现锁的降级。</p></blockquote> <iframe id="embed_dom" name="embed_dom" frameborder="0" src="https://www.processon.com/embed/60efe8155653bb06f24c1df7" style="display:block;width:725px;height:245px;"></iframe> <p><strong>偏向锁</strong></p> <blockquote><p>为了减少同一线程获取锁(会涉及到一些CAS操作,耗时)的代价而引入偏向锁。偏向锁的核心思想是，如果一个线程获得了锁，那么锁就进入偏向模式，此时Mark Word 的结构也变为偏向锁结构，当这个线程再次请求锁时，无需再做任何同步操作，即获取锁的过程，这样就省去了大量有关锁申请的操作，从而也就提供程序的性能。所以，对于没有锁竞争的场合，偏向锁有很好的优化效果，毕竟极有可能连续多次是同一个线程申请相同的锁。但是对于锁竞争比较激烈的场合，偏向锁就失效了，因为这样场合极有可能每次申请锁的线程都是不相同的，因此这种场合下不应该使用偏向锁，否则会得不偿失，需要注意的是，偏向锁失败后，并不会立即膨胀为重量级锁，而是先升级为轻量级锁。</p></blockquote> <ul><li><p>JDK 1.6 开始默认开启偏向锁</p></li> <li><p>在jdk15中偏向锁默认关闭</p></li> <li><p>开启偏向锁：<code>-XX:+UseBiasedLocking</code></p></li> <li><p>关闭偏向锁：<code>-XX:-UseBiasedLocking</code></p></li> <li><p>偏向锁生效时间：<code>-XX:BiasedLockingStartupDelay=5</code></p></li></ul> <p><strong>轻量级锁</strong></p> <blockquote><p>倘若偏向锁失败，虚拟机并不会立即升级为重量级锁，它还会尝试使用一种称为轻量级锁的优化手段(1.6之后加入的)，此时Mark Word 的结构也变为轻量级锁的结构。轻量级锁能够提升程序性能的依据是“对绝大部分的锁，在整个同步周期内都不存在竞争”，注意这是经验数据。需要了解的是，轻量级锁所适应的场景是线程交替执行同步块的场合，如果存在同一时间访问同一锁的场合，就会导致轻量级锁膨胀为重量级锁。</p></blockquote> <p><strong>锁消除</strong></p> <blockquote><p>消除锁是虚拟机另外一种锁的优化，这种优化更彻底，Java虚拟机在JIT编译时(可以简单理解为当某段代码即将第一次被执行时进行编译，又称即时编译)，通过对运行上下文的扫描，去除不可能存在共享资源竞争的锁，通过这种方式消除没有必要的锁，可以节省毫无意义的请求锁时间，如下StringBuffer的append是一个同步方法，但是在add方法中的StringBuffer属于一个局部变量，并且不会被其他线程所使用，因此StringBuffer不可能存在共享资源竞争的情景，JVM会自动将其锁消除。<strong>锁消除的依据是逃逸分析的数据支持。</strong></p></blockquote> <ul><li>锁消除，前提是java必须运行在server模式（server模式会比client模式作更多的优化），<strong>同时必须开启逃逸分析</strong></li> <li>开启锁消除：-XX:+EliminateLocks</li></ul> <p><strong>逃逸分析</strong></p> <p>使用逃逸分析，编译器可以对代码做如下优化：</p> <ul><li><p>同步省略。如果一个对象被发现只能从一个线程被访问到，那么对于这个对象的操作可以不考虑同步。</p></li> <li><p>将堆分配转化为栈分配。如果一个对象在子程序中被分配，要使指向该对象的指针永远不会逃逸，对象可能是栈分配的候选，而不是堆分配。</p></li> <li><p>分离对象或标量替换。有的对象可能不需要作为一个连续的内存结构存在也可以被访问到，那么对象的部分（或全部）可以不存储在内存，而是存储在CPU寄存器中。</p></li> <li><p>开启逃逸分析， <code>-XX:+DoEscapeAnalysis</code></p></li> <li><p>从jdk 1.7开始已经默认开启逃逸分析，如需关闭，需要指定<code>-XX:-DoEscapeAnalysis</code></p></li></ul> <h3 id="wait-notify"><a href="#wait-notify" class="header-anchor">#</a> wait notify</h3> <blockquote><p>只能在获得同步锁后使用</p> <p>调用wait后进入 waitSet 队列吗，等待 notify</p></blockquote> <ul><li>有些情况 WaitSet 的对象会被移动到 EntryList</li></ul> <iframe id="embed_dom" name="embed_dom" frameborder="0" src="https://www.processon.com/embed/60f555b1637689739c3e5294" style="display:block;width:725px;height:245px;"></iframe></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/db117/doc/edit/master/docs/java/JVM/synchronized.md" target="_blank" rel="noopener noreferrer">编辑文档！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/29/2021, 11:07:15 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java/JVM/jvm远程访问.html" class="prev">
        java开启远程访问
      </a></span> <span class="next"><a href="/java/JVM/垃圾回收.html">
        垃圾回收
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0602046f.js" defer></script><script src="/assets/js/2.0d3614ae.js" defer></script><script src="/assets/js/26.ba3f6ee3.js" defer></script>
  </body>
</html>
