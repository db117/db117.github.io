(window.webpackJsonp=window.webpackJsonp||[]).push([[107],{472:function(e,s,n){"use strict";n.r(s);var a=n(27),t=Object(a.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("blockquote",[n("p",[n("a",{attrs:{href:"https://github.com/prometheus-operator/kube-prometheus",target:"_blank",rel:"noopener noreferrer"}},[e._v("kube-prometheus"),n("OutboundLink")],1)]),e._v(" "),n("p",[e._v("该项目使用"),n("code",[e._v("jsonnet")]),e._v("编写，上手有一定难度。")]),e._v(" "),n("p",[e._v("主要是在 k8s 中部署监控的一系列工具。")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://github.com/prometheus-operator/prometheus-operator",target:"_blank",rel:"noopener noreferrer"}},[e._v("Prometheus Operator"),n("OutboundLink")],1)]),e._v(" "),n("li",[e._v("高可用 "),n("a",{attrs:{href:"https://prometheus.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Prometheus"),n("OutboundLink")],1)]),e._v(" "),n("li",[e._v("高可用 "),n("a",{attrs:{href:"https://github.com/prometheus/alertmanager",target:"_blank",rel:"noopener noreferrer"}},[e._v("Alertmanager"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/prometheus/node_exporter",target:"_blank",rel:"noopener noreferrer"}},[e._v("Prometheus node-exporter"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/DirectXMan12/k8s-prometheus-adapter",target:"_blank",rel:"noopener noreferrer"}},[e._v("Prometheus Adapter for Kubernetes Metrics APIs"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://github.com/kubernetes/kube-state-metrics",target:"_blank",rel:"noopener noreferrer"}},[e._v("kube-state-metrics"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://grafana.com/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Grafana"),n("OutboundLink")],1)])])]),e._v(" "),n("h2",{attrs:{id:"简单使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#简单使用"}},[e._v("#")]),e._v(" 简单使用")]),e._v(" "),n("blockquote",[n("p",[e._v("对默认的没有特别的要求情况下可以直接使用")])]),e._v(" "),n("h3",{attrs:{id:"前置条件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前置条件"}},[e._v("#")]),e._v(" 前置条件")]),e._v(" "),n("ul",[n("li",[e._v("go环境")]),e._v(" "),n("li",[e._v("安装jb(jsonnet-bundler)\n"),n("ul",[n("li",[e._v("使用go安装"),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("go get github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])])]),e._v(" "),n("li",[e._v("使用brewhome安装"),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[e._v(" brew "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" jsonnet-bundler\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])])])])]),e._v(" "),n("li",[e._v("gojsontoyaml安装"),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("go get github.com/brancz/gojsontoyaml\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])])])]),e._v(" "),n("h3",{attrs:{id:"使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用"}},[e._v("#")]),e._v(" 使用")]),e._v(" "),n("ul",[n("li",[n("p",[e._v("修改配置文件")]),e._v(" "),n("blockquote",[n("p",[e._v("example.jsonnet")])])]),e._v(" "),n("li",[n("p",[e._v("生成文件")]),e._v(" "),n("blockquote",[n("p",[e._v("运行"),n("code",[e._v("./build.sh example.jsonnet")]),e._v(" 会在"),n("code",[e._v("manifests")]),e._v("目录生成配置文件")])])]),e._v(" "),n("li",[n("p",[e._v("格式化.jsonnet")]),e._v(" "),n("blockquote",[n("p",[e._v("需要安装jsonnetfmt")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("  git clone git@github.com:google/go-jsonnet.git\n  cd go-jsonnet\n  go build ./cmd/jsonnetfmt\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br")])]),n("blockquote",[n("p",[e._v("使用vsCode的"),n("code",[e._v("jsonnet Formatter")]),e._v("插件\n或者使用下面代码直接格式化")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v(" jsonnetfmt --indent 2 --max-blank-lines 2 --sort-imports --string-style s --comment-style s -i test.jsonnet  \n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])])])]),e._v(" "),n("h3",{attrs:{id:"注意事项"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[e._v("#")]),e._v(" 注意事项")]),e._v(" "),n("ul",[n("li",[e._v("vendor目录是jb生成的")]),e._v(" "),n("li",[e._v("除配置文件都是从github上面copy的不需要修改直接"),n("code",[e._v("jb update")])])]),e._v(" "),n("h2",{attrs:{id:"自定义配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#自定义配置"}},[e._v("#")]),e._v(" 自定义配置")]),e._v(" "),n("blockquote",[n("p",[e._v("默认的配置,不满足的情况下。")]),e._v(" "),n("p",[e._v("实际上都是对生成的文件进行修改，如果不想写配置文件，可以直接对生成的文件进行修改使用。")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("local filter = {\n  // 过滤某些通知，也可以对 alertmanager-config.yaml 添加抑制配置\n  kubernetesControlPlane+:: {\n    prometheusRule+: {\n      spec+: {\n        groups: std.filter(\n          function(group)\n            group.name != 'kubernetes-system-scheduler'\n            && group.name != 'kubernetes-system-controller-manager',\n          super.groups\n        ),\n      },\n    },\n  },\n};\n\nlocal update = {\n\t// 对默认的配置进行修改\n  // 调整报警阈值\n  kubernetesControlPlane+:: {\n    prometheusRule+: {\n      spec+: {\n        groups: std.map(\n          function(group)\n            if group.name == 'kubernetes-resources' then\n              group {\n                rules: std.map(\n                  function(rule)\n                    if rule.alert == 'CPUThrottlingHigh' then\n                      rule {\n                        expr: |||\nsum(increase(container_cpu_cfs_throttled_periods_total{container!=\"\", }[5m])) by (container, pod, namespace)\n                            /\n                          sum(increase(container_cpu_cfs_periods_total{}[5m])) by (container, pod, namespace)\n                            > ( 70 / 100 )\n                        |||,\n                      }\n                    else\n                      rule,\n                  group.rules\n                ),\n              }\n            else\n              group,\n          super.groups\n        ),\n      },\n    },\n  },\n};\n\nlocal kp =\n  (import 'kube-prometheus/main.libsonnet') +\n  (import 'kube-prometheus/addons/all-namespaces.libsonnet') + // 监听全部命名空间\n  {\n    values+:: {\n      common+: {\n        namespace: 'monitoring',  // 工作命名空间\n        images+: {\n          // 替换镜像\n          kubeStateMetrics: 'bitnami/kube-state-metrics:' + $.values.common.versions.kubeStateMetrics,\n        },\n      },\n      alertmanager+: {\n        config: importstr 'alertmanager-config.yaml',  // alertmanager 配置文件\n        replicas: 1,\n      },\n    },\n    // 添加储存类\n    prometheus+:: {\n      prometheus+: {\n        spec+: {\n          retention: '30d',\n          replicas: 1,\n          storage: {\n            volumeClaimTemplate: {\n              apiVersion: 'v1',\n              kind: 'PersistentVolumeClaim',\n              spec: {\n                accessModes: ['ReadWriteOnce'],\n                resources: { requests: { storage: '100Gi' } },\n                storageClassName: 'nfs-dynamic-class',\n              },\n            },\n          },  // storage\n        },  // spec\n      },  // prometheus\n    },  // prometheus\n  } + filter + update;\n\n// 下面的不要动\n{ 'setup/0namespace-namespace': kp.kubePrometheus.namespace } +\n{\n  ['setup/prometheus-operator-' + name]: kp.prometheusOperator[name]\n  for name in std.filter((function(name) name != 'serviceMonitor' && name != 'prometheusRule'), std.objectFields(kp.prometheusOperator))\n} +\n// serviceMonitor and prometheusRule are separated so that they can be created after the CRDs are ready\n{ 'prometheus-operator-serviceMonitor': kp.prometheusOperator.serviceMonitor } +\n{ 'prometheus-operator-prometheusRule': kp.prometheusOperator.prometheusRule } +\n{ 'kube-prometheus-prometheusRule': kp.kubePrometheus.prometheusRule } +\n{ ['alertmanager-' + name]: kp.alertmanager[name] for name in std.objectFields(kp.alertmanager) } +\n{ ['blackbox-exporter-' + name]: kp.blackboxExporter[name] for name in std.objectFields(kp.blackboxExporter) } +\n{ ['grafana-' + name]: kp.grafana[name] for name in std.objectFields(kp.grafana) } +\n{ ['kube-state-metrics-' + name]: kp.kubeStateMetrics[name] for name in std.objectFields(kp.kubeStateMetrics) } +\n{ ['kubernetes-' + name]: kp.kubernetesControlPlane[name] for name in std.objectFields(kp.kubernetesControlPlane) }\n{ ['node-exporter-' + name]: kp.nodeExporter[name] for name in std.objectFields(kp.nodeExporter) } +\n{ ['prometheus-' + name]: kp.prometheus[name] for name in std.objectFields(kp.prometheus) } +\n{ ['prometheus-adapter-' + name]: kp.prometheusAdapter[name] for name in std.objectFields(kp.prometheusAdapter) }\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br"),n("span",{staticClass:"line-number"},[e._v("39")]),n("br"),n("span",{staticClass:"line-number"},[e._v("40")]),n("br"),n("span",{staticClass:"line-number"},[e._v("41")]),n("br"),n("span",{staticClass:"line-number"},[e._v("42")]),n("br"),n("span",{staticClass:"line-number"},[e._v("43")]),n("br"),n("span",{staticClass:"line-number"},[e._v("44")]),n("br"),n("span",{staticClass:"line-number"},[e._v("45")]),n("br"),n("span",{staticClass:"line-number"},[e._v("46")]),n("br"),n("span",{staticClass:"line-number"},[e._v("47")]),n("br"),n("span",{staticClass:"line-number"},[e._v("48")]),n("br"),n("span",{staticClass:"line-number"},[e._v("49")]),n("br"),n("span",{staticClass:"line-number"},[e._v("50")]),n("br"),n("span",{staticClass:"line-number"},[e._v("51")]),n("br"),n("span",{staticClass:"line-number"},[e._v("52")]),n("br"),n("span",{staticClass:"line-number"},[e._v("53")]),n("br"),n("span",{staticClass:"line-number"},[e._v("54")]),n("br"),n("span",{staticClass:"line-number"},[e._v("55")]),n("br"),n("span",{staticClass:"line-number"},[e._v("56")]),n("br"),n("span",{staticClass:"line-number"},[e._v("57")]),n("br"),n("span",{staticClass:"line-number"},[e._v("58")]),n("br"),n("span",{staticClass:"line-number"},[e._v("59")]),n("br"),n("span",{staticClass:"line-number"},[e._v("60")]),n("br"),n("span",{staticClass:"line-number"},[e._v("61")]),n("br"),n("span",{staticClass:"line-number"},[e._v("62")]),n("br"),n("span",{staticClass:"line-number"},[e._v("63")]),n("br"),n("span",{staticClass:"line-number"},[e._v("64")]),n("br"),n("span",{staticClass:"line-number"},[e._v("65")]),n("br"),n("span",{staticClass:"line-number"},[e._v("66")]),n("br"),n("span",{staticClass:"line-number"},[e._v("67")]),n("br"),n("span",{staticClass:"line-number"},[e._v("68")]),n("br"),n("span",{staticClass:"line-number"},[e._v("69")]),n("br"),n("span",{staticClass:"line-number"},[e._v("70")]),n("br"),n("span",{staticClass:"line-number"},[e._v("71")]),n("br"),n("span",{staticClass:"line-number"},[e._v("72")]),n("br"),n("span",{staticClass:"line-number"},[e._v("73")]),n("br"),n("span",{staticClass:"line-number"},[e._v("74")]),n("br"),n("span",{staticClass:"line-number"},[e._v("75")]),n("br"),n("span",{staticClass:"line-number"},[e._v("76")]),n("br"),n("span",{staticClass:"line-number"},[e._v("77")]),n("br"),n("span",{staticClass:"line-number"},[e._v("78")]),n("br"),n("span",{staticClass:"line-number"},[e._v("79")]),n("br"),n("span",{staticClass:"line-number"},[e._v("80")]),n("br"),n("span",{staticClass:"line-number"},[e._v("81")]),n("br"),n("span",{staticClass:"line-number"},[e._v("82")]),n("br"),n("span",{staticClass:"line-number"},[e._v("83")]),n("br"),n("span",{staticClass:"line-number"},[e._v("84")]),n("br"),n("span",{staticClass:"line-number"},[e._v("85")]),n("br"),n("span",{staticClass:"line-number"},[e._v("86")]),n("br"),n("span",{staticClass:"line-number"},[e._v("87")]),n("br"),n("span",{staticClass:"line-number"},[e._v("88")]),n("br"),n("span",{staticClass:"line-number"},[e._v("89")]),n("br"),n("span",{staticClass:"line-number"},[e._v("90")]),n("br"),n("span",{staticClass:"line-number"},[e._v("91")]),n("br"),n("span",{staticClass:"line-number"},[e._v("92")]),n("br"),n("span",{staticClass:"line-number"},[e._v("93")]),n("br"),n("span",{staticClass:"line-number"},[e._v("94")]),n("br"),n("span",{staticClass:"line-number"},[e._v("95")]),n("br"),n("span",{staticClass:"line-number"},[e._v("96")]),n("br"),n("span",{staticClass:"line-number"},[e._v("97")]),n("br"),n("span",{staticClass:"line-number"},[e._v("98")]),n("br"),n("span",{staticClass:"line-number"},[e._v("99")]),n("br"),n("span",{staticClass:"line-number"},[e._v("100")]),n("br"),n("span",{staticClass:"line-number"},[e._v("101")]),n("br"),n("span",{staticClass:"line-number"},[e._v("102")]),n("br"),n("span",{staticClass:"line-number"},[e._v("103")]),n("br"),n("span",{staticClass:"line-number"},[e._v("104")]),n("br"),n("span",{staticClass:"line-number"},[e._v("105")]),n("br"),n("span",{staticClass:"line-number"},[e._v("106")]),n("br"),n("span",{staticClass:"line-number"},[e._v("107")]),n("br"),n("span",{staticClass:"line-number"},[e._v("108")]),n("br")])])])}),[],!1,null,null,null);s.default=t.exports}}]);