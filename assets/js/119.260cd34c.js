(window.webpackJsonp=window.webpackJsonp||[]).push([[119],{510:function(t,e,s){"use strict";s.r(e);var n=s(31),a=Object(n.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#介绍"}},[t._v("#")]),t._v(" 介绍")]),t._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"https://github.com/prometheus-operator/kube-prometheus",target:"_blank",rel:"noopener noreferrer"}},[t._v("prometheus-operator/kube-prometheus: Use Prometheus to monitor Kubernetes and applications running on Kubernetes (github.com)"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("通过自定义资源来配置管理各种组件")]),t._v(" "),s("p",[t._v("通过各种 "),s("code",[t._v("config-reloader")]),t._v(" 来修改各种配置")])]),t._v(" "),s("p",[s("strong",[t._v("自定义资源")])]),t._v(" "),s("ul",[s("li",[s("strong",[s("code",[t._v("Prometheus")])]),t._v(", 定义了一个Prometheus deployment。")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("Alertmanager")])]),t._v(",定义了一个 Alertmanager deployment.")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("ThanosRuler")])]),t._v(", 定义了一个 Thanos Ruler deployment.")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("ServiceMonitor")])]),t._v(",定义一组"),s("code",[t._v("service")]),t._v("端点，prometheus 主动会拉取数据")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("PodMonitor")])]),t._v(", 定义一组"),s("code",[t._v("pod")]),t._v("端点，prometheus 主动会拉取数据")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("Probe")])]),t._v(", 支持对"),s("code",[t._v("ingress")]),t._v("静态url进行数据拉取")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("PrometheusRule")])]),t._v(", 定义"),s("code",[t._v("rule")]),t._v("规则")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("AlertmanagerConfig")])]),t._v(", 定义报警规则")])]),t._v(" "),s("h2",{attrs:{id:"简单使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简单使用"}},[t._v("#")]),t._v(" 简单使用")]),t._v(" "),s("p",[t._v("可直接 clone 项目使用")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('# 先创建命名空间，已经自定义资源。然后在创建一系列资源\nkubectl create -f manifests/setup\nuntil kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo ""; done\nkubectl create -f manifests/\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("全部删除")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("kubectl delete --ignore-not-found=true -f manifests/ -f manifests/setup\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("需要自己来添加 ingress 来访问service")]),t._v(" "),s("ul",[s("li",[t._v("告警服务 "),s("code",[t._v("alertmanager-main:9093")])]),t._v(" "),s("li",[t._v("prometheus "),s("code",[t._v("prometheus-k8s:9090")])]),t._v(" "),s("li",[t._v("Grafana "),s("code",[t._v("grafana:3000")])])]),t._v(" "),s("p",[t._v("默认是没有配置报警接收器，需要修改配置。详情见后面。")]),t._v(" "),s("h2",{attrs:{id:"普通使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#普通使用"}},[t._v("#")]),t._v(" 普通使用")]),t._v(" "),s("blockquote",[s("p",[t._v("通过自定义的"),s("code",[t._v("k8s")]),t._v("组件对各种服务进行动态配置")]),t._v(" "),s("p",[t._v("可以通过简单的k8s自定义资源对整个监控系统进行配置")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("ServiceMonitor")]),t._v(" "),s("blockquote",[s("p",[t._v("选择一部分 "),s("code",[t._v("service")]),t._v("来生成 "),s("code",[t._v("target")]),t._v("配置。")])]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("apiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    app.kubernetes.io/name: backend\n  name: backend\n  namespace: hillinsight\nspec:\n  endpoints:\t\t\t\t\t\t\t\t\t\t\t# 定义一组端点\n    - interval: 10s \t\t\t\t\t\t\t# 拉取周期\n      path: /actuator/prometheus  # 路径\n      port: backend-port   \t\t\t\t# 端口\n      scheme: http  \t\t\t\t\t\t\t# 请求方式\n      basicAuth: ***  \t\t\t\t\t\t# 认证\n      bearerTokenFile: \t\t\t\t\t\t# 权限认证\n      metricRelabelings:  \t\t\t\t# 指标处理\n  jobLabel: backend\t\t\t\t\t\t\t\t# 对拉取的数据添加 label\n  namespaceSelector: \t\t\t\t\t\t\t# 命名空间选择\n    matchNames:\n      - test\n  selector:  \t\t\t\t\t\t\t\t\t\t\t# 选择服务\n    matchLabels:\n      prometheus: backend\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("PodMonitor")]),t._v(" "),s("blockquote",[s("p",[t._v("选择一部分 "),s("code",[t._v("pod")]),t._v("来生成 "),s("code",[t._v("target")]),t._v("配置。")])]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("apiVersion: monitoring.coreos.com/v1\nkind: PodMonitor\nmetadata:\n  labels:\n    app.kubernetes.io/name: backend\n  name: backend\n  namespace: hillinsight\nspec:\n  podMetricsEndpoints:\t\t\t\t\t\t# 定义一组端点\n    - interval: 10s \t\t\t\t\t\t\t# 拉取周期\n      path: /actuator/prometheus  # 路径\n      port: backend-port   \t\t\t\t# 端口\n      scheme: http  \t\t\t\t\t\t\t# 请求方式\n      basicAuth: ***  \t\t\t\t\t\t# 认证\n      bearerTokenFile: \t\t\t\t\t\t# 权限认证\n      metricRelabelings:  \t\t\t\t# 指标处理\n  jobLabel: backend\t\t\t\t\t\t\t\t# 对拉取的数据添加 label\n  namespaceSelector: \t\t\t\t\t\t\t# 命名空间选择\n    matchNames:\n      - test\n  selector:  \t\t\t\t\t\t\t\t\t\t\t# 选择 pod\n    matchLabels:\n      prometheus: backend\n\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("PrometheusRule")]),t._v(" "),s("blockquote",[s("p",[t._v("添加 "),s("code",[t._v("Prometheus")]),t._v("的报警规则")])]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  annotations: {}\n  labels:\n    prometheus: k8s\n  name: main-rules\n  namespace: monitoring\nspec:\n  groups:\n    - name: groupName  \t\t\t\t# 分组名称\n      rules:\n        - alert: alertName  \t# 报警名称\n          annotations:\n            description: desc # 详情\n            runbook_url: url  # 点击后访问的地址\n            summary: test  \t\t# 概要\n          expr: \t\t\t\t\t\t\t# 规则表达式\n          for: 10m  \t\t\t\t\t# 持续时间，满足后才报警\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br")])])]),t._v(" "),s("li",[s("p",[t._v("AlertmanagerConfig")]),t._v(" "),s("blockquote",[s("p",[t._v("修改通知规则，"),s("code",[t._v("Prometheus")]),t._v("生成报警后，发送到 "),s("code",[t._v("Alertmanager")]),t._v("。进行分组，抑制，通知。")]),t._v(" "),s("p",[t._v("简单使用，不建议使用。"),s("code",[t._v("kube-prometheus")]),t._v("中并没有添加支持。")]),t._v(" "),s("p",[t._v("如需修改可以直接修改 "),s("code",[t._v("alertmanager-main")]),t._v("Secret")])])])])])}),[],!1,null,null,null);e.default=a.exports}}]);