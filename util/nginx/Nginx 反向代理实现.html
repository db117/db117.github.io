<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx 反向代理实现 | 大兵个人主页</title>
    <meta name="description" content="文档">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.4d86c1e3.css" as="style"><link rel="preload" href="/assets/js/app.8db5c4b9.js" as="script"><link rel="preload" href="/assets/js/2.67dcd2b1.js" as="script"><link rel="preload" href="/assets/js/63.7d95afe8.js" as="script"><link rel="prefetch" href="/assets/js/10.2a96a1ac.js"><link rel="prefetch" href="/assets/js/11.820297f1.js"><link rel="prefetch" href="/assets/js/12.545c705e.js"><link rel="prefetch" href="/assets/js/13.5f907662.js"><link rel="prefetch" href="/assets/js/14.c214924d.js"><link rel="prefetch" href="/assets/js/15.714a8fa1.js"><link rel="prefetch" href="/assets/js/16.06171069.js"><link rel="prefetch" href="/assets/js/17.f97a45dd.js"><link rel="prefetch" href="/assets/js/18.29a4f30d.js"><link rel="prefetch" href="/assets/js/19.f0c4551f.js"><link rel="prefetch" href="/assets/js/20.daa4d367.js"><link rel="prefetch" href="/assets/js/21.f3b7e9f9.js"><link rel="prefetch" href="/assets/js/22.ad5a865e.js"><link rel="prefetch" href="/assets/js/23.bb382903.js"><link rel="prefetch" href="/assets/js/24.8cf130c6.js"><link rel="prefetch" href="/assets/js/25.a25edfff.js"><link rel="prefetch" href="/assets/js/26.3924d413.js"><link rel="prefetch" href="/assets/js/27.a7eed53c.js"><link rel="prefetch" href="/assets/js/28.eb0f9e5d.js"><link rel="prefetch" href="/assets/js/29.efb6ef5b.js"><link rel="prefetch" href="/assets/js/3.fe9e1b4e.js"><link rel="prefetch" href="/assets/js/30.c1a77117.js"><link rel="prefetch" href="/assets/js/31.5d1a578b.js"><link rel="prefetch" href="/assets/js/32.95b304a0.js"><link rel="prefetch" href="/assets/js/33.975c793a.js"><link rel="prefetch" href="/assets/js/34.7c700c61.js"><link rel="prefetch" href="/assets/js/35.e6b61dda.js"><link rel="prefetch" href="/assets/js/36.a4f5024f.js"><link rel="prefetch" href="/assets/js/37.ba27896c.js"><link rel="prefetch" href="/assets/js/38.14dc9b75.js"><link rel="prefetch" href="/assets/js/39.41660db7.js"><link rel="prefetch" href="/assets/js/4.7d932259.js"><link rel="prefetch" href="/assets/js/40.6902fc3a.js"><link rel="prefetch" href="/assets/js/41.2dfd5620.js"><link rel="prefetch" href="/assets/js/42.02081c8b.js"><link rel="prefetch" href="/assets/js/43.7db0d54c.js"><link rel="prefetch" href="/assets/js/44.41a320ed.js"><link rel="prefetch" href="/assets/js/45.0a7a7c56.js"><link rel="prefetch" href="/assets/js/46.744a6be9.js"><link rel="prefetch" href="/assets/js/47.5f941225.js"><link rel="prefetch" href="/assets/js/48.8b723015.js"><link rel="prefetch" href="/assets/js/49.1f4d833a.js"><link rel="prefetch" href="/assets/js/5.ef36d5a4.js"><link rel="prefetch" href="/assets/js/50.86634242.js"><link rel="prefetch" href="/assets/js/51.78c24d4d.js"><link rel="prefetch" href="/assets/js/52.a9cd7f30.js"><link rel="prefetch" href="/assets/js/53.10a6190d.js"><link rel="prefetch" href="/assets/js/54.d58acd33.js"><link rel="prefetch" href="/assets/js/55.ba5229d2.js"><link rel="prefetch" href="/assets/js/56.2ee647bd.js"><link rel="prefetch" href="/assets/js/57.ef869ac8.js"><link rel="prefetch" href="/assets/js/58.41858576.js"><link rel="prefetch" href="/assets/js/59.37ea0b81.js"><link rel="prefetch" href="/assets/js/6.b7645180.js"><link rel="prefetch" href="/assets/js/60.d85e114f.js"><link rel="prefetch" href="/assets/js/61.dfb92399.js"><link rel="prefetch" href="/assets/js/62.25b06dbd.js"><link rel="prefetch" href="/assets/js/64.465bb77f.js"><link rel="prefetch" href="/assets/js/65.878d270b.js"><link rel="prefetch" href="/assets/js/66.010e31ba.js"><link rel="prefetch" href="/assets/js/67.8c909ca1.js"><link rel="prefetch" href="/assets/js/68.571c6f8e.js"><link rel="prefetch" href="/assets/js/69.36898d34.js"><link rel="prefetch" href="/assets/js/7.c57ead44.js"><link rel="prefetch" href="/assets/js/70.cc0f3981.js"><link rel="prefetch" href="/assets/js/71.49751256.js"><link rel="prefetch" href="/assets/js/8.f0ab160e.js"><link rel="prefetch" href="/assets/js/9.7203880a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4d86c1e3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">大兵个人主页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">导航</a></div><div class="nav-item"><a href="/java/" class="nav-link">java</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">系统</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/os/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/os/windows/" class="nav-link">Windows</a></li><li class="dropdown-item"><!----> <a href="/os/centos/" class="nav-link">CentOS</a></li><li class="dropdown-item"><!----> <a href="/os/ubuntu/" class="nav-link">Ubuntu</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/util/git/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/util/nginx/" class="nav-link router-link-active">nginx</a></li></ul></div></div><div class="nav-item"><a href="/docker/" class="nav-link">docker</a></div><div class="nav-item"><a href="/other/" class="nav-link">其他</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://v1.vuepress.vuejs.org/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress1.x 官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/db117/doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">导航</a></div><div class="nav-item"><a href="/java/" class="nav-link">java</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">系统</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/os/linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/os/windows/" class="nav-link">Windows</a></li><li class="dropdown-item"><!----> <a href="/os/centos/" class="nav-link">CentOS</a></li><li class="dropdown-item"><!----> <a href="/os/ubuntu/" class="nav-link">Ubuntu</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/database/mysql/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/database/redis/" class="nav-link">redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开发工具</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/util/git/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/util/nginx/" class="nav-link router-link-active">nginx</a></li></ul></div></div><div class="nav-item"><a href="/docker/" class="nav-link">docker</a></div><div class="nav-item"><a href="/other/" class="nav-link">其他</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://v1.vuepress.vuejs.org/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  VuePress1.x 官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <a href="https://github.com/db117/doc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>nginx</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/util/nginx/" class="sidebar-link">Nginx</a></li><li><a href="/util/nginx/Nginx 反向代理实现.html" class="active sidebar-link">Nginx 反向代理实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/util/nginx/Nginx 反向代理实现.html#_1-nginx代理基本配置" class="sidebar-link">1.Nginx代理基本配置</a></li><li class="sidebar-sub-header"><a href="/util/nginx/Nginx 反向代理实现.html#_2-负载均衡配置与参数解析" class="sidebar-link">2.负载均衡配置与参数解析</a></li><li class="sidebar-sub-header"><a href="/util/nginx/Nginx 反向代理实现.html#_3-upstream-负载均衡算法介绍" class="sidebar-link">3.upstream 负载均衡算法介绍</a></li></ul></li><li><a href="/util/nginx/Nginx 性能参数调优.html" class="sidebar-link">Nginx 性能参数调优</a></li><li><a href="/util/nginx/Nginx 配置与使用.html" class="sidebar-link">Nginx 配置与使用</a></li><li><a href="/util/nginx/Nginx安装.html" class="sidebar-link">编译与安装</a></li><li><a href="/util/nginx/nginx.html" class="sidebar-link">nginx配置</a></li><li><a href="/util/nginx/nginx-docker.html" class="sidebar-link">docker 启动</a></li><li><a href="/util/nginx/nginx-https.html" class="sidebar-link">配置文件</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx-反向代理实现"><a href="#nginx-反向代理实现" aria-hidden="true" class="header-anchor">#</a> Nginx 反向代理实现</h1> <ol><li>反向代理基本配置</li> <li>负载均衡配置与参数解析</li> <li>负载均衡算法详解</li> <li>反向代理基本配置</li></ol> <p>提问：什么是反向代理其与正向代理有什么区别？
<strong>正向代理的概念：</strong>
正向代理是指客户端与目标服务器之间增加一个代理服务器，客户端直接访问代理服务器，在由代理服务器访问目标服务器并返回客户端并返回 。这个过程当中客户端需要知道代理服务器地址，并配置连接。
<img src="https://images-cdn.shimo.im/Toh3jB1uHeodiycl/image.png!thumbnail" alt="图片"></p> <p><strong>反向代理的概念：</strong>
反向代理是指 客户端访问目标服务器，在目标服务内部有一个统一接入网关将请求转发至后端真正处理的服务器并返回结果。这个过程当中客户端不需要知道代理服务器地址，代理对客户端而言是透明的。</p> <p><img src="https://images-cdn.shimo.im/i8oQuJikm9EREsxz/image.png!thumbnail" alt="图片"></p> <p><strong>反向代理与正向代理的区别</strong></p> <table><thead><tr><th style="text-align:left;"></th> <th style="text-align:left;"><strong>正向代理</strong></th> <th style="text-align:left;"><strong>反向代理</strong></th></tr></thead> <tbody><tr><td style="text-align:left;">代理服务器位置</td> <td style="text-align:left;">客户端与服务都能连接的们位置</td> <td style="text-align:left;">目标服务器内部</td></tr> <tr><td style="text-align:left;">主要作用</td> <td style="text-align:left;">屏蔽客户端IP、集中式缓存、解决客户端不能直连服务端的问题。</td> <td style="text-align:left;">屏蔽服务端内部实现、负载均衡、缓存。</td></tr> <tr><td style="text-align:left;">应用场景</td> <td style="text-align:left;">爬虫、翻墙、maven 的nexus 服务</td> <td style="text-align:left;">Nginx 、Apache负载均衡应用</td></tr></tbody></table> <h2 id="_1-nginx代理基本配置"><a href="#_1-nginx代理基本配置" aria-hidden="true" class="header-anchor">#</a> 1.Nginx代理基本配置</h2> <p>Nginx 代理只需要配置 location 中配置proxy_pass 属性即可。其指向代理的服务器地址。</p> <div class="language- extra-class"><pre class="language-text"><code># 正向代理到baidu 服务
location = /baidu.html {
         proxy_pass http://www.baidu.com;
}
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code># 反向代理至 本机的8010服务
location /luban/ {
     proxy_pass http://127.0.0.1:8010;  
}
</code></pre></div><p><strong>代理相关参数：</strong></p> <div class="language- extra-class"><pre class="language-text"><code># 代理服务
proxy_pass
# 是否允许重定向
proxy_redirect off; 
# 传 header 参数至后端服务
proxy_set_header Host $host; 
# 设置request header 即客户端IP 地址
proxy_set_header X-Forwarded-For $remote_addr; 
# 连接代理服务超时时间
proxy_connect_timeout 90; 
# 请求发送最大时间
proxy_send_timeout 90; 
# 读取最大时间
proxy_read_timeout 90;  
proxy_buffer_size 4k; 
proxy_buffers 4 32k;
proxy_busy_buffers_size 64k; 
proxy_temp_file_write_size 64k;
</code></pre></div><h2 id="_2-负载均衡配置与参数解析"><a href="#_2-负载均衡配置与参数解析" aria-hidden="true" class="header-anchor">#</a> 2.负载均衡配置与参数解析</h2> <p>通过proxy_pass 可以把请求代理至后端服务，但是为了实现更高的负载及性能， 我们的后端服务通常是多个， 这个是时候可以通过upstream 模块实现负载均衡。</p> <p><strong>演示upstream 的实现。</strong></p> <div class="language- extra-class"><pre class="language-text"><code>upstream backend {     
   server 127.0.0.1:8010 weight=1;
   server 127.0.0.1:8080 weight=2;

  server 127.0.0.1:8030 weight=1 backup;
}
location / {
    proxy_pass http://backend;
}
</code></pre></div><p><strong>upstream 相关参数:</strong></p> <ul><li>server	反向服务地址 加端口</li> <li>**weight	 **权重</li> <li>**max_fails	**失败多少次 认为主机已挂掉则，踢出</li> <li>**fail_timeout	**踢出后重新探测时间</li> <li>**backup	**备用服务</li> <li>**max_conns	**允许最大连接数</li> <li>**slow_start	**当节点恢复，不立即加入,而是等待 slow_start	后加入服务对列。</li></ul> <h2 id="_3-upstream-负载均衡算法介绍"><a href="#_3-upstream-负载均衡算法介绍" aria-hidden="true" class="header-anchor">#</a> 3.upstream 负载均衡算法介绍</h2> <ul><li>**ll+weight： **轮询加权重 (默认)</li> <li>**ip_hash : **基于Hash 计算 ,用于保持session 一至性</li> <li><strong>url_hash:</strong> 静态资源缓存,节约存储，加快速度（第三方）</li> <li>**least_conn **：最少链接（第三方）</li> <li>**least_time  **：最小的响应时间,计算节点平均响应时间，然后取响应最快的那个，分配更高权重（第三方）</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/db117/doc/edit/master/docs/util/nginx/Nginx 反向代理实现.md" target="_blank" rel="noopener noreferrer">编辑文档！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">9/3/2019, 6:30:27 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/util/nginx/" class="prev router-link-active">
          Nginx
        </a></span> <span class="next"><a href="/util/nginx/Nginx 性能参数调优.html">
          Nginx 性能参数调优
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8db5c4b9.js" defer></script><script src="/assets/js/2.67dcd2b1.js" defer></script><script src="/assets/js/63.7d95afe8.js" defer></script>
  </body>
</html>
